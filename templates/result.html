<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detection Results - YOLOv8 Object Detection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
</head>
<body>
    <header>
        <h1>Detection Results</h1>
        <p>YOLOv8 Object Detection Analysis</p>
    </header>
    
    <main>
        <div class="result-container">
            <div class="results-header">
                <h2>Object Detection Complete!</h2>
                {% if detections %}
                    <p>Found <strong>{{ detections|length }}</strong> object(s) in your image</p>
                {% else %}
                    <p>No objects detected in the image</p>
                {% endif %}
            </div>
            
            <div class="image-comparison">
                <div class="image-container">
                    <h3>üì∑ Original Image</h3>
                    <img src="{{ url_for('uploaded_file', filename=original_img.split('/')[-1]) }}" 
                         alt="Original uploaded image" 
                         loading="lazy">
                </div>
                
                <div class="image-container">
                    <h3>üéØ Detection Results</h3>
                    <img src="{{ url_for('uploaded_file', filename=result_img.split('/')[-1]) }}" 
                         alt="Image with detected objects highlighted" 
                         loading="lazy">
                </div>
            </div>
              {% if detections %}
            <div class="detection-results">
                <h3>üìã Detection Details</h3>
                <div class="detection-summary">
                    <p><strong>Total Objects:</strong> {{ detections|length }}</p>
                    <p><strong>Object Types:</strong> {{ detections|map(attribute='class')|unique|list|join(', ')|title }}</p>
                    <p><strong>Average Confidence:</strong> {{ "%.1f"|format((detections|map(attribute='confidence')|sum / detections|length)) }}%</p>
                </div>
                
                <div class="detection-list">
                    {% for detection in detections %}
                    <div class="detection-item">
                        <div class="detection-class">
                            üè∑Ô∏è {{ detection.class|title }}
                            <span class="detection-confidence">{{ detection.confidence }}%</span>
                        </div>
                        <div class="detection-coords">
                            üìç Bounding Box: ({{ detection.bbox[0] }}, {{ detection.bbox[1] }}) ‚Üí ({{ detection.bbox[2] }}, {{ detection.bbox[3] }})
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if model_info %}
            <div class="model-info">
                <h4>ü§ñ Model Information</h4>
                <p><strong>Model:</strong> {{ model_info.model_path.split('/')[-1] }}</p>
                <p><strong>Confidence Threshold:</strong> {{ model_info.confidence_threshold }}</p>
                <p><strong>Supported Classes:</strong> {{ model_info.class_names|length }} object types</p>
            </div>
            {% endif %}            <div style="text-align: center; margin-top: 2rem;">
                <a href="{{ url_for('index') }}" class="btn">
                    üîÑ Analyze Another Image
                </a>
                <button onclick="downloadResults()" class="btn btn-secondary">
                    üíæ Download Results
                </button>
                <button onclick="toggleComparison()" class="btn btn-success">
                    üîç Toggle Comparison View
                </button>
            </div>
        </div>

        <div class="result-container">
            <h3>üìä Detection Statistics</h3>
            {% if detections %}
            <div class="features-grid">
                {% set class_counts = {} %}
                {% for detection in detections %}
                    {% if class_counts.update({detection.class: class_counts.get(detection.class, 0) + 1}) %}{% endif %}
                {% endfor %}
                
                {% for class_name, count in class_counts.items() %}
                <div class="feature-card">
                    <div class="feature-icon">{{ count }}</div>
                    <h4>{{ class_name|title }}</h4>
                    <p>{{ 'Object' if count == 1 else 'Objects' }} detected</p>
                </div>
                {% endfor %}
            </div>
            
            <div style="margin-top: 1rem;">
                <p><strong>Average Confidence:</strong> 
                {{ "%.1f"|format(detections|map(attribute='confidence')|sum / detections|length) }}%
                </p>
            </div>
            {% else %}
            <p style="text-align: center; color: #7f8c8d;">
                No objects were detected in this image. Try uploading a different image with more common objects.
            </p>
            {% endif %}
        </div>
    </main>
    
    <footer>
        <p>Powered by YOLOv8 and Flask | Built with ‚ù§Ô∏è for AI enthusiasts</p>
    </footer>
      <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        function downloadResults() {
            // Get data from the page elements
            const detectionsElements = document.querySelectorAll('.detection-item');
            const detections = [];
            
            detectionsElements.forEach(item => {
                const classElement = item.querySelector('.detection-class');
                const confidenceElement = item.querySelector('.detection-confidence');
                const coordsElement = item.querySelector('.detection-coords');
                
                if (classElement && confidenceElement && coordsElement) {
                    const className = classElement.textContent.replace('üè∑Ô∏è ', '').trim();
                    const confidence = parseFloat(confidenceElement.textContent.match(/[\d.]+/)[0]);
                    const coords = coordsElement.textContent.match(/\d+/g).map(num => parseInt(num));
                    
                    detections.push({
                        class: className,
                        confidence: confidence,
                        bbox: coords
                    });
                }
            });
            
            const resultsData = {
                timestamp: new Date().toISOString(),
                total_objects: detections.length,
                detections: detections
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(resultsData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "detection_results_" + new Date().toISOString().slice(0,19).replace(/:/g, '-') + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();        }

        // Toggle comparison view functionality
        function toggleComparison() {
            const imageComparison = document.querySelector('.image-comparison');
            const toggleBtn = document.querySelector('button[onclick="toggleComparison()"]');
            
            if (imageComparison.style.display === 'none') {
                imageComparison.style.display = 'grid';
                toggleBtn.textContent = 'üîç Hide Comparison View';
            } else {
                imageComparison.style.display = 'none';
                toggleBtn.textContent = 'üîç Show Comparison View';
            }
        }

        // Add smooth animations and interactions
        document.addEventListener('DOMContentLoaded', function() {
            // Animate detection items on load
            const detectionItems = document.querySelectorAll('.detection-item');
            detectionItems.forEach((item, index) => {
                item.style.opacity = '0';
                item.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    item.style.transition = 'all 0.5s ease-out';
                    item.style.opacity = '1';
                    item.style.transform = 'translateY(0)';
                }, index * 100);
            });

            // Add click handlers for image zoom
            const images = document.querySelectorAll('.image-container img');
            images.forEach(img => {
                img.style.cursor = 'pointer';
                img.addEventListener('click', function() {
                    // Create modal for full-size image view
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                        cursor: pointer;
                    `;
                    
                    const modalImg = document.createElement('img');
                    modalImg.src = this.src;
                    modalImg.style.cssText = `
                        max-width: 90%;
                        max-height: 90%;
                        border-radius: 8px;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
                    `;
                    
                    modal.appendChild(modalImg);
                    document.body.appendChild(modal);
                    
                    modal.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                });
            });
        });
    </script>
</body>
</html>
